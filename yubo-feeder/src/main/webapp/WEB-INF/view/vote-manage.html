<html>
<head>
<link rel="stylesheet" type="text/css"
	href="http://o7pmdbbe0.bkt.clouddn.com/css/easyui/material/easyui.css">
<link rel="stylesheet" type="text/css"
	href="http://o7pmdbbe0.bkt.clouddn.com/css/easyui/icon.css">
<link rel="stylesheet" type="text/css"
	href="http://www.jeasyui.net/Public/js/easyui/demo/demo.css">
<script type="text/javascript"
	src="http://www.jeasyui.net/Public/js/jquery.js"></script>
<script type="text/javascript"
	src="http://o7pmdbbe0.bkt.clouddn.com/js/easyui/jquery.easyui.min.js"></script>
</head>

<body>
	<div id="#center-box" data-options="region:'center',title:'工作区'"
		style="padding: 10px 25px;">
		<h2>投票管理</h2>

		<table id="dg" title="投票管理" style="width: auto; height: 450px"
			data-options="singleSelect:true,pagination:true,url:'/vote/load',method:'get',fitColumns:'true',toolbar:'#toolbar'">
			<thead>
				<tr>
					<th field="voteId" width="40">投票ID</th>
					<th field="voteTitle" width="50" align="center">标题</th>
					<th field="voteQuestion" width="120">问题</th>
					<th field="voteAnswer" width="120" align="center"
						formatter="formatAnswer">答案</th>
					<th field="activeDate" width="50" align="center" formatter="formatDate">激活日期</th>
					<th field="colorStyle" width="80" align="center">色彩方案</th>
				</tr>
			</thead>
		</table>
		<div id="toolbar">
			<a href="javascript:void(0)" class="easyui-linkbutton"
				iconCls="icon-add" plain="true" onclick="newVote()">添加</a> <a
				href="javascript:void(0)" class="easyui-linkbutton"
				iconCls="icon-edit" plain="true" onclick="editVote()">修改</a> <a
				href="javascript:void(0)" class="easyui-linkbutton"
				iconCls="icon-edit" plain="true" onclick="editVote()">删除</a>
		</div>

		<div id="dlg" class="easyui-dialog"
			style="width: 780px; height: auto; padding: 10px 20px" closed="true"
			buttons="#dlg-buttons" enctype="application/x-www-form-urlencoded">
			<form id="fm" method="post" novalidate>
				<div class="fitem">
					<label>标题:</label> <input name="voteTitle" class="easyui-textbox"
						style="width: 200px; height: 26px;"
						data-options="prompt:'20字之内，暂时不展示，用来搜索',required:true,validType:{length:[0,20]}">
				</div>
				<div class="fitem">
					<label>问题:</label> <input name="voteQuestion"
						class="easyui-textbox" style="width: 300px; height: 26px;"
						data-options="prompt:'投票问题内容，不超过30个字',required:true,validType:{length:[0,30]}">
				</div>
				<div class="fitem">
					<label>激活日期:</label> <input id="voteDate" name="voteDate"
						style="width: 160px; height: 26px">
				</div>

				<div class="fitem">
					<label>答案1:</label> <input name="voteAnswerOneDiscription"
						class="easyui-textbox" style="width: 200px; height: 26px;"
						data-options="prompt:'描述，不超过20个字',required:true,validType:{length:[0,20]}" />
					<input name="voteAnswerOneKey" class="easyui-textbox"
						style="width: 160px; height: 26px;"
						data-options="prompt:'投票关键字，不超过4个字',required:true,validType:{length:[0,4]}" />
					<a href="javascript:void(0)" class="easyui-linkbutton c6"
						onclick="newSvgSelect(this)" style="width: 90px" iconIdx="1">图标</a>
					<span class="icon-preview-1"></span>
					<input name="voteAnswerOneIconId" type="hidden" />
				</div>

				<div class="fitem">
					<label>答案2:</label> <input name="voteAnswerTwoDiscription"
						class="easyui-textbox" style="width: 200px; height: 26px;"
						data-options="prompt:'描述，不超过20个字',required:true,validType:{length:[0,20]}" />
					<input name="voteAnswerTwoKey" class="easyui-textbox"
						style="width: 160px; height: 26px;"
						data-options="prompt:'投票关键字，不超过4个字',required:true,validType:{length:[0,4]}" />
					<a href="javascript:void(0)" class="easyui-linkbutton c6"
						onclick="newSvgSelect(this)" style="width: 90px" iconIdx="2">图标</a>
					<span class="icon-preview-2"></span>
					<input name="voteAnswerTwoIconId" type="hidden" />
				</div>

			</form>
		</div>


		<div id="svgDlg" class="easyui-dialog"
			style="width: 800px; height: auto; padding: 10px 20px" closed="true"
			buttons="#svgDlg-buttons" enctype="application/x-www-form-urlencoded">
			<table id="svgTb" title="svg备选" style="width: auto; height: 450px" class="easyui-datagrid"
				data-options="pagination:true,showPageList:false,showRefresh:false,url:'/svg/load/select',method:'get',fitColumns:'true',onClickCell:svgIconClick">
				<thead>
					<tr>
						<th field="svgOne" width="100px" formatter="formatSVG" align="center"></th>
						<th field="svgTwo" width="100px" formatter="formatSVG" align="center"></th>
						<th field="svgThree" width="100px" formatter="formatSVG" align="center"></th>
						<th field="svgFour" width="100px" formatter="formatSVG" align="center"></th>
						<th field="svgFive" width="100px" formatter="formatSVG" align="center"></th>
						<th field="svgSix" width="100px" formatter="formatSVG" align="center"></th>
						<th field="svgSeven" width="100px" formatter="formatSVG" align="center"></th>
						<th field="svgEight" width="100px" formatter="formatSVG" align="center"></th>
						<th field="svgNine" width="100px" formatter="formatSVG" align="center"></th>
						<th field="svgTen" width="100px" formatter="formatSVG" align="center"></th>
					</tr>
				</thead>
			</table>
		</div>


		<div id="dlg-buttons">
			<a href="javascript:void(0)" class="easyui-linkbutton c6"
				iconCls="icon-ok" onclick="saveVote()" style="width: 90px">Save</a>
			<a href="javascript:void(0)" class="easyui-linkbutton"
				iconCls="icon-cancel" onclick="javascript:$('#dlg').dialog('close')"
				style="width: 90px">Cancel</a>
		</div>

		<div id="svgDlg-buttons">
			<a href="javascript:void(0)" class="easyui-linkbutton c6"
				iconCls="icon-ok" onclick="chooseSvg()" style="width: 90px">选择</a>
			<a href="javascript:void(0)" class="easyui-linkbutton"
				iconCls="icon-cancel"
				onclick="javascript:$('#svgDlg').dialog('close')"
				style="width: 90px">Cancel</a>
		</div>
	</div>

</body>
</html>
<script type="text/javascript">

	Date.prototype.format = function(format) {
	    var date = {
	           "M+": this.getMonth() + 1,
	           "d+": this.getDate(),
	           "h+": this.getHours(),
	           "m+": this.getMinutes(),
	           "s+": this.getSeconds(),
	           "q+": Math.floor((this.getMonth() + 3) / 3),
	           "S+": this.getMilliseconds()
	    };
	    if (/(y+)/i.test(format)) {
	           format = format.replace(RegExp.$1, (this.getFullYear() + '').substr(4 - RegExp.$1.length));
	    }
	    for (var k in date) {
	           if (new RegExp("(" + k + ")").test(format)) {
	                  format = format.replace(RegExp.$1, RegExp.$1.length == 1
	                         ? date[k] : ("00" + date[k]).substr(("" + date[k]).length));
	           }
	    }
	    return format;
	}

	var answerIcon1 = {};
	var answerIcon2 = {};
	var selectAnswerIdx;
	var selectSvgId;
	var selectSvgContent;
	var clickIconTbIdx;
	
	function getHeight(percent) {
		var h = $(window).height() * percent;
		return h;
	}

	function formatAnswer(val, row) {
		var returnStr = "";
		for (var i = 0; i < val.length; i++) {
			if (val[i].key != undefined) {
				var item = '<div style="overflow:hidden"><ul style="list-style:none;text-align:left;float:left;padding:5px 0;margin:0 5px 0 20px;"><li>'
						+ val[i].discription
						+ '</li><li>【'
						+ val[i].key
						+ '】</li></ul><div style="float: right;margin:15px 50px 15px 0;">'
						+ val[i].svg + '</div></div>';
				returnStr = item + returnStr;
			}
		}
		return returnStr;
	}
	
	function formatDate(val, row) {
		var date = new Date();
		date.setTime(val);
		return date.format('yyyy-MM-dd');
	}

	var url;
	function newVote() {
		$('#dlg').dialog('open').dialog('center').dialog('setTitle', '添加投票');
		$('#fm').form('clear');
		url = '/vote/add';
	}
	function editVote() {
		var row = $('#dg').datagrid('getSelected');
		if (row) {
			$('#dlg').dialog('open').dialog('center')
					.dialog('setTitle', '修改投票');
			$('#fm').form('load', row);
			url = '/vote/udpate';
		}
	}
	function saveVote() {
		$('#fm').form('submit', {
			url : url,
			onSubmit : function() {
				return $(this).form('validate');
			},
			success : function(result) {
				var result = eval('(' + result + ')');
				if (result != 200) {
					$.messager.show({
						title : 'Error',
						msg : result.errorMsg
					});
				} else {
					$('#dlg').dialog('close'); // close the dialog
					$('#dg').datagrid('reload'); // reload the user data
				}
			}
		});
	}
	
	function chooseSvg(){
		$('#svgDlg').dialog('close');
		$('.icon-preview-'+selectAnswerIdx).html(selectSvgContent).next().val(selectSvgId);
		if(clickIconTbIdx!=undefined){
			$($('#svgDlg .datagrid-btable td')[clickIconTbIdx]).css("backgroud","#FFF");
		}
	}

	function newSvgSelect(tag){
		$('#svgDlg').dialog('open').dialog('center').dialog('setTitle', '选择投票答案图标');
		selectAnswerIdx = $(tag).attr('iconIdx');
	}
	
	function formatSVG(val, row) {
		var text = "";
		if(val!=undefined){
	    	text = '<div style="text-align:center;padding-top:15px;">'+val.svgContent+'</div><p style="font-size:12px;text-align:center">'+val.svgTag+'</p>';
		}
        return text;
     }

	function svgIconClick(index,field,value){
		if(value!=undefined){
			var currentIdx = value.svgIconIndex;
			if(currentIdx!=clickIconTbIdx){
				selectSvgId = value.svgId;
				selectSvgContent = value.svgContent;
				var tdArray = $('#svgDlg .datagrid-btable td');
				if(clickIconTbIdx==undefined){
					clickIconTbIdx = value.svgIconIndex;
					$(tdArray[clickIconTbIdx]).css("background","#E7E3F1")
				}else{
					$(tdArray[clickIconTbIdx]).css("background","#FFF");
					$(tdArray[currentIdx]).css("background","#E7E3F1");
					clickIconTbIdx = currentIdx;
				}
			}
		}
	}
	
	$(function() {
		$('#dg').datagrid({
			height : getHeight(0.85),
			onLoadSuccess : function(data) {
				$('svg').attr('width', '24px').attr('height', '24px');
			},
		});
		
		 $('#voteDate').datebox().datebox('calendar').calendar({
             validator: function(date){
                 var now = new Date();
                 return date > now;
             }
         });
		
	});
</script>
<style type="text/css">
#fm {
	margin: 0;
	padding: 10px 30px;
}

.ftitle {
	font-size: 14px;
	font-weight: bold;
	padding: 5px 0;
	margin-bottom: 10px;
	border-bottom: 1px solid #ccc;
}

.fitem {
	margin-bottom: 10px;
}

.fitem label {
	display: inline-block;
	width: 80px;
}

.fitem input {
	width: 160px;
}

#center-box {
	padding: 20px;
}

.datagrid-cell-c1-voteQuestion {
	white-space: normal;
}

.textbox-invalid {
	box-shadow: 0 0 2px #FF0B0B;
}

.datagrid-row-over{
	background-color: #FFF;
	color:#000;
}

#svgDlg td:hover{
	cursor: pointer;
	background-color: #E2E2E2;
}

#svgDlg .datagrid-row-selected{
	background-color: #FFF;
	color:#000;
}

</style>
